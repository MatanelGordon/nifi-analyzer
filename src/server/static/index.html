<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<link rel="icon" href="favicon.ico" type="image/x-icon" />
		<link rel="stylesheet" href="index.css" />
		<script src="/socket.io/socket.io.js"></script>
		<script src="terminal.js" defer></script>
		<script src="index.js" defer></script>
		<title>Nifi Analyzer</title>
	</head>
	<body>
		<button class="help-button" id="help-btn" type="button" title="About this project">?</button>
		<button class="terminal-toggle-button" id="terminal-toggle-btn" type="button" title="Toggle Terminal">></button>
		<button class="llm-button" id="setup-llm" type="button" title="Set up LLM">LLM</button>
		
		<!-- Terminal Display -->
		<div class="terminal-container" id="terminal-container">
			<div class="terminal-header">
				<span class="terminal-title">NiFi Analyzer Terminal</span>
				<button class="terminal-close" id="terminal-close-btn" type="button">√ó</button>
			</div>
			<pre class="terminal-output" id="terminal-output"></pre>
		</div>
		
		<form class="content-wrapper" id="analyze-form">
			<h1 class="title">Nifi Analyzer</h1>
			<div class="field">
				<input
					class="field__input"
					type="url"
					id="URL__input"
					name="url"
					required
					autocomplete="url"
				/>
				<label class="field__label" for="URL__input">URL</label>
			</div>
			<div class="field">
				<input
					class="field__input"
					type="text"
					id="USER__input"
					name="username"
					required
					autocomplete="username"
				/>
				<label class="field__label" for="USER__input">Username</label>
			</div>
			<div class="field">
				<input
					class="field__input"
					type="password"
					id="PSW__input"
					name="password"
					required
					autocomplete="current-password"
				/>
				<label class="field__label" for="PSW__input">Password</label>
			</div>
			<div class="field">
				<input
					class="field__input"
					type="text"
					id="PGID__input"
					name="pgid"
					autocomplete="off"
				/>
				<label class="field__label" for="PGID__input">Process Group ID [default: root]</label>
			</div>
			<div class="field">
				<input
					class="field__input"
					type="number"
					id="PROVENANCE__input"
					name="provenanceLimit"
					value="100000"
					min="0"
					autocomplete="off"
				/>
				<label class="field__label" for="PROVENANCE__input">Max Processor Provenance Events</label>
				<span class="field__hint">* 0 means no provenance</span>
			</div>
            <div class="footer">
                <button class="nifi-button" id="analyze">Analyze</button>
				<a class="nifi-button2" id="get-file" download style="display: none;">Get File</a>
            </div>
            <p class="output" id="output"></p>
		</form>

		<!-- LLM Setup Modal -->
		<dialog id="llm-modal" class="llm-modal">
			<div class="modal-content">
				<div class="modal-header">
					<h2>LLM Setup Instructions</h2>
					<button class="close-btn" id="close-modal">&times;</button>
				</div>
				<div class="modal-body">
					<span class="instruction">Copy the following content to your LLM (ChatGPT, Claude, etc.):</span>
					<div class="content-container">
						<pre id="llm-content" class="llm-content">Loading...</pre>
						<div class="button-group">
							<button class="copy-btn nifi-button" id="select-content">Select All</button>
							<button class="copy-btn nifi-button" id="copy-content">Copy</button>
						</div>
					</div>
				</div>
			</div>
		</dialog>

		<!-- Help Modal -->
		<dialog id="help-modal" class="llm-modal">
			<div class="modal-content">
				<div class="modal-header">
					<h2>About NiFi Analyzer</h2>
					<button class="close-btn" id="close-help-modal">&times;</button>
				</div>
				<div class="modal-body">
					<div class="help-content">
						<h3>What is NiFi Analyzer?</h3>
						<p>Tired of not understanding why your NiFi sucks?</p>
						<p>NiFi Analyzer is a TypeScript application that extracts processor information and performance metrics from Apache NiFi process groups and stores them in a SQLite database for comprehensive analysis.</p>
						
						<h3>Key Features:</h3>
						<ul>
							<li>üîç Recursively extracts processor information from all nested process groups</li>
							<li>üìä Comprehensive performance metrics collection and analysis</li>
							<li>üíæ Stores data in SQLite database with structured schema</li>
							<li>ü§ñ LLM compatible - use AI to help create SQL queries for analysis</li>
						</ul>

						<h3>How to use:</h3>
						<ol>
							<li>Enter your NiFi instance URL and credentials</li>
							<li>Optionally specify a Process Group ID (leave empty for root)</li>
							<li>Set Max Processor Provenance Events (0 to disable, default 100,000)</li>
							<li>Click "Analyze" to extract all data</li>
							<li>Download the generated SQLite database file</li>
							<li>Use the LLM button to get schema documentation for AI-assisted queries</li>
						</ol>

						<h3>What data is collected:</h3>
						<ul>
							<li><strong>Processors:</strong> Configuration, properties, and status history</li>
							<li><strong>Connections:</strong> Relationships between processors and endpoints</li>
							<li><strong>Provenance Events:</strong> FlowFile lifecycle events and attributes</li>
							<li><strong>Performance Metrics:</strong> Historical performance data for analysis</li>
							<li><strong>System Info:</strong> NiFi cluster node information</li>
						</ul>

						<h3>What can you do with it?</h3>
						<ul>
							<li>üîç Detect bottlenecks by querying performance data</li>
							<li>üìä Create custom visualizations using DataGrip, Apache Superset, or your own UI</li>
							<li>üß† Use LLMs to help analyze your data with natural language queries</li>
							<li>üìà Track trends and identify optimization opportunities</li>
						</ul>

						<p><strong>Note:</strong> All analysis is performed server-side. Your database file is automatically deleted after 10 minutes for security.</p>
					</div>
				</div>
			</div>
		</dialog>

		<script>
			// LLM Modal functionality
			const setupLlmBtn = document.getElementById('setup-llm');
			const llmModal = document.getElementById('llm-modal');
			const closeModalBtn = document.getElementById('close-modal');
			const copyContentBtn = document.getElementById('copy-content');
			const llmContentPre = document.getElementById('llm-content');

			// Load LLM content
			async function loadLlmContent() {
				llmContentPre.textContent = 'Loading...';
				try {
					const response = await fetch('/llm.md');
					if (response.ok) {
						const content = await response.text();
						if (content.trim()) {
							llmContentPre.textContent = content;
						} else {
							llmContentPre.textContent = 'LLM content is empty. Please check if llm.md exists.';
						}
					} else {
						llmContentPre.textContent = `Error loading LLM content. Status: ${response.status}. Please try again.`;
					}
				} catch (error) {
					console.error('Error loading LLM content:', error);
					llmContentPre.textContent = 'Error loading LLM content: ' + error.message;
				}
			}

			// Open modal
			setupLlmBtn.addEventListener('click', () => {
				llmModal.showModal();
				loadLlmContent();
			});

			// Close modal
			closeModalBtn.addEventListener('click', () => {
				llmModal.close();
			});

			// Close modal when clicking outside
			llmModal.addEventListener('click', (e) => {
				if (e.target === llmModal) {
					llmModal.close();
				}
			});

			// Close modal with Escape key
			document.addEventListener('keydown', (e) => {
				if (e.key === 'Escape' && llmModal.open) {
					llmModal.close();
				}
			});

			// Copy content to clipboard
			copyContentBtn.addEventListener('click', async () => {
				let success = false;
				
				// Try modern Clipboard API first (requires HTTPS or localhost)
				if (navigator.clipboard && window.isSecureContext) {
					try {
						await navigator.clipboard.writeText(llmContentPre.textContent);
						success = true;
					} catch (error) {
						console.warn('Clipboard API failed:', error);
					}
				}
				
				// Fallback for HTTP or older browsers
				if (!success) {
					try {
						// Create a temporary textarea
						const textArea = document.createElement('textarea');
						textArea.value = llmContentPre.textContent;
						
						// Style to be invisible but still interactable
						textArea.style.top = '0';
						textArea.style.left = '0';
						textArea.style.position = 'fixed';
						textArea.style.width = '2em';
						textArea.style.height = '2em';
						textArea.style.padding = '0';
						textArea.style.border = 'none';
						textArea.style.outline = 'none';
						textArea.style.boxShadow = 'none';
						textArea.style.background = 'transparent';
						
						document.body.appendChild(textArea);
						textArea.focus();
						textArea.select();
						
						// Try to copy
						try {
							success = document.execCommand('copy');
							console.log('execCommand result:', success);
						} catch (err) {
							console.error('execCommand error:', err);
						}
						
						document.body.removeChild(textArea);
					} catch (fallbackError) {
						console.error('Fallback copy failed:', fallbackError);
					}
				}
				
				// Update button text
				if (success) {
					copyContentBtn.textContent = 'Copied!';
				} else {
					// If both methods failed, show instruction to manually copy
					copyContentBtn.textContent = 'Select & Copy Manually';
					// Select the pre element content for manual copying
					const selection = window.getSelection();
					const range = document.createRange();
					range.selectNodeContents(llmContentPre);
					selection.removeAllRanges();
					selection.addRange(range);
				}
				
				setTimeout(() => {
					copyContentBtn.textContent = 'Copy';
				}, 3000);
			});

			// Select all content
			const selectContentBtn = document.getElementById('select-content');
			selectContentBtn.addEventListener('click', () => {
				const selection = window.getSelection();
				const range = document.createRange();
				range.selectNodeContents(llmContentPre);
				selection.removeAllRanges();
				selection.addRange(range);
				selectContentBtn.textContent = 'Selected!';
				setTimeout(() => {
					selectContentBtn.textContent = 'Select All';
				}, 2000);
			});

			// Help Modal functionality
			const helpBtn = document.getElementById('help-btn');
			const helpModal = document.getElementById('help-modal');
			const closeHelpModalBtn = document.getElementById('close-help-modal');

			helpBtn.addEventListener('click', () => {
				helpModal.showModal();
			});

			closeHelpModalBtn.addEventListener('click', () => {
				helpModal.close();
			});

			helpModal.addEventListener('click', (e) => {
				if (e.target === helpModal) {
					helpModal.close();
				}
			});
		</script>
	</body>
</html>
