<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<link rel="icon" href="favicon.ico" type="image/x-icon" />
		<link rel="stylesheet" href="index.css" />
		<script src="index.js" defer></script>
		<title>Nifi Analyzer</title>
	</head>
	<body>
		<form class="content-wrapper" id="analyze-form">
			<h1 class="title">Nifi Analyzer</h1>
			<div class="field">
				<input
					class="field__input"
					type="url"
					id="URL__input"
					name="url"
					required
					autocomplete="url"
				/>
				<label class="field__label" for="URL__input">URL</label>
			</div>
			<div class="field">
				<input
					class="field__input"
					type="text"
					id="USER__input"
					name="username"
					required
					autocomplete="username"
				/>
				<label class="field__label" for="USER__input">Username</label>
			</div>
			<div class="field">
				<input
					class="field__input"
					type="password"
					id="PSW__input"
					name="password"
					required
					autocomplete="current-password"
				/>
				<label class="field__label" for="PSW__input">Password</label>
			</div>
			<div class="field">
				<input
					class="field__input"
					type="text"
					id="PGID__input"
					name="pgid"
					autocomplete="off"
				/>
				<label class="field__label" for="PGID__input">Process Group ID [default: root]</label>
			</div>
			<div class="field">
				<input
					class="field__input"
					type="number"
					id="PROVENANCE__input"
					name="provenanceLimit"
					value="100000"
					min="0"
					autocomplete="off"
				/>
				<label class="field__label" for="PROVENANCE__input">Max Processor Provenance Events</label>
				<span class="field__hint">* 0 means no provenance</span>
			</div>
            <div class="footer">
                <button class="nifi-button" id="analyze">Analyze</button>
                <button class="nifi-button2" id="setup-llm" type="button">Set up LLM</button>
				<a class="nifi-button2" id="get-file" download style="display: none;">Get File</a>
            </div>
            <p class="output" id="output"></p>
		</form>

		<!-- LLM Setup Modal -->
		<dialog id="llm-modal" class="llm-modal">
			<div class="modal-content">
				<div class="modal-header">
					<h2>LLM Setup Instructions</h2>
					<button class="close-btn" id="close-modal">&times;</button>
				</div>
				<div class="modal-body">
					<span class="instruction">Copy the following content to your LLM (ChatGPT, Claude, etc.):</span>
					<div class="content-container">
						<pre id="llm-content" class="llm-content">Loading...</pre>
						<div class="button-group">
							<button class="copy-btn nifi-button" id="select-content">Select All</button>
							<button class="copy-btn nifi-button" id="copy-content">Copy</button>
						</div>
					</div>
				</div>
			</div>
		</dialog>

		<script>
			// LLM Modal functionality
			const setupLlmBtn = document.getElementById('setup-llm');
			const llmModal = document.getElementById('llm-modal');
			const closeModalBtn = document.getElementById('close-modal');
			const copyContentBtn = document.getElementById('copy-content');
			const llmContentPre = document.getElementById('llm-content');

			// Load LLM content
			async function loadLlmContent() {
				llmContentPre.textContent = 'Loading...';
				try {
					const response = await fetch('/llm.md');
					if (response.ok) {
						const content = await response.text();
						if (content.trim()) {
							llmContentPre.textContent = content;
						} else {
							llmContentPre.textContent = 'LLM content is empty. Please check if llm.md exists.';
						}
					} else {
						llmContentPre.textContent = `Error loading LLM content. Status: ${response.status}. Please try again.`;
					}
				} catch (error) {
					console.error('Error loading LLM content:', error);
					llmContentPre.textContent = 'Error loading LLM content: ' + error.message;
				}
			}

			// Open modal
			setupLlmBtn.addEventListener('click', () => {
				llmModal.showModal();
				loadLlmContent();
			});

			// Close modal
			closeModalBtn.addEventListener('click', () => {
				llmModal.close();
			});

			// Close modal when clicking outside
			llmModal.addEventListener('click', (e) => {
				if (e.target === llmModal) {
					llmModal.close();
				}
			});

			// Close modal with Escape key
			document.addEventListener('keydown', (e) => {
				if (e.key === 'Escape' && llmModal.open) {
					llmModal.close();
				}
			});

			// Copy content to clipboard
			copyContentBtn.addEventListener('click', async () => {
				let success = false;
				
				// Try modern Clipboard API first (requires HTTPS or localhost)
				if (navigator.clipboard && window.isSecureContext) {
					try {
						await navigator.clipboard.writeText(llmContentPre.textContent);
						success = true;
					} catch (error) {
						console.warn('Clipboard API failed:', error);
					}
				}
				
				// Fallback for HTTP or older browsers
				if (!success) {
					try {
						// Create a temporary textarea
						const textArea = document.createElement('textarea');
						textArea.value = llmContentPre.textContent;
						
						// Style to be invisible but still interactable
						textArea.style.top = '0';
						textArea.style.left = '0';
						textArea.style.position = 'fixed';
						textArea.style.width = '2em';
						textArea.style.height = '2em';
						textArea.style.padding = '0';
						textArea.style.border = 'none';
						textArea.style.outline = 'none';
						textArea.style.boxShadow = 'none';
						textArea.style.background = 'transparent';
						
						document.body.appendChild(textArea);
						textArea.focus();
						textArea.select();
						
						// Try to copy
						try {
							success = document.execCommand('copy');
							console.log('execCommand result:', success);
						} catch (err) {
							console.error('execCommand error:', err);
						}
						
						document.body.removeChild(textArea);
					} catch (fallbackError) {
						console.error('Fallback copy failed:', fallbackError);
					}
				}
				
				// Update button text
				if (success) {
					copyContentBtn.textContent = 'Copied!';
				} else {
					// If both methods failed, show instruction to manually copy
					copyContentBtn.textContent = 'Select & Copy Manually';
					// Select the pre element content for manual copying
					const selection = window.getSelection();
					const range = document.createRange();
					range.selectNodeContents(llmContentPre);
					selection.removeAllRanges();
					selection.addRange(range);
				}
				
				setTimeout(() => {
					copyContentBtn.textContent = 'Copy';
				}, 3000);
			});

			// Select all content
			const selectContentBtn = document.getElementById('select-content');
			selectContentBtn.addEventListener('click', () => {
				const selection = window.getSelection();
				const range = document.createRange();
				range.selectNodeContents(llmContentPre);
				selection.removeAllRanges();
				selection.addRange(range);
				selectContentBtn.textContent = 'Selected!';
				setTimeout(() => {
					selectContentBtn.textContent = 'Select All';
				}, 2000);
			});
		</script>
	</body>
</html>
